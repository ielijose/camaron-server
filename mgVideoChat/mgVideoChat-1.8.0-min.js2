window.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection;window.PeerConnection=(window.webkitPeerConnection00||window.webkitPeerConnection||window.PeerConnection);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;window.RTCSessionDescription=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;window.RTCIceCandidate=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate;(function(g,j,k,e){var f={wsURL:"ws://localhost:8080",dir:"{rel}",tplMain:"/tpls/main.html",tplConnections:"/tpls/connections.html",tplConnection:"/tpls/connection.html",tplChat:"/tpls/chat.html",tplChatInput:"/tpls/chat_input.html",tplRoulette:"/tpls/roulette.html",tplFile:"/tpls/file.html",tplYou:"/tpls/you.html",sound:{mp3:"/sounds/ring.mp3",ogg:"/sounds/ring.ogg"},notifySound:{mp3:"/sounds/notify.mp3",ogg:"/sounds/notify.ogg"},debug:false,login:null,rtc:{pcConfig:{iceServers:[{url:"stun:stun.l.google.com:19302"}]},pcConstraints:{optional:[{DtlsSrtpKeyAgreement:true}]},offerConstraints:{optional:[],mandatory:{}},mediaConstraints:{audio:true,video:true},sdpConstraints:{mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true},optional:[{VoiceActivityDetection:false}]},audio_receive_codec:"opus/48000"},fileMaxSize:512000};var d={};var l=function(n,m){this.version="1";this.elem=n;this.$elem=g(n);this.$connectionsPanel=null;this.options=m;this.metadata=this.$elem.data("mgVideoChat-options");this.config=g.extend({},f,this.options);d=this.config;c.init(this.config.rtc);this.fixPath();this.init();this.$elem.data("mgVideoChat-instance",this);this.chatId=null;this.videoId=null;this.videoInvitedId=null;this.connectionId=null;this.userData={};this.roomOptions={};this.localStream=null;this.files={};this.isMuted={audio:false,video:false};this.events={}};l.prototype.fixPath=function(){if(this.config.dir!="{rel}"){return}var m=this;g("script").each(function(){var q=g(this).attr("src");var p="mgVideoChat-";if(q&&q.indexOf(p,this.length-p.length)!==-1){m.config.dir=q.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,"");var o=/mgVideoChat\-(\d*\.\d*\.\d*)\.js/gi;var n=o.exec(q);if(n&&n[1]){m.version=n[1]}else{o=/mgVideoChat\-(\d*\.\d*\.\d*)\-min\.js/gi;n=o.exec(q);if(n&&n[1]){m.version=n[1]}else{m.version=1}}}else{p="mgVideoChat";if(q&&q.indexOf(p,this.length-p.length)!==-1){m.config.dir=q.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,"");m.version=1}}})};l.prototype.init=function(){var m=this;this.loadTplByName("tplConnections",function(n){m.loadTplByName("tplMain",function(q){m.$elem.html(m.tmpl(q,{config:m.config}));m.$connectionsPanel=m.$elem.find("#connectionsPanel");m.$messagePanel=m.$elem.find("#messagePanel");m.$loginPanel=m.$elem.find("#loginPanel");m.$videoPanel=m.$elem.find("#videoPanel");m.$loginDialog=m.$elem.find("#loginDialog");m.$callPanel=m.$elem.find("#callPanel");m.$answerDialog=m.$elem.find("#answerDialog");m.$fileAcceptDialog=m.$elem.find("#fileAcceptDialog");m.$chatPanel=m.$elem.find("#chatPanel");m.$filesPanel=m.$elem.find("#filesPanel");m.$youInfoPanel=m.$elem.find("#youInfoPanel");var s={};if(!c.checkCompatibility(s)){m.debug(s);var r={websocket:m._("Your browser does not support websocket."),peerconnection:m._("Your browser does not support PeerConnections."),usermedia:m._("Your browser does not support user media.")};var p=[];for(var o in s){p.push(r[o])}p.push(m._('Please try <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> or <a href="http://www.mozilla.org/en-US/firefox" target="_blank">Mozilla Firefox</a>'));m.message(p.join("<br>"),"danger")}else{c.connect(m.config.wsURL)}m.initDom();m.initRtc()});m.loadTplByName("tplChatInput",function(o){})})};l.prototype.initDom=function(){var n=this;n.$loginPanel.find("#loginButton").click(function(){if(n.config.login){n.config.login(function(){c.login()})}else{n.$loginDialog.modal("show")}});n.$loginDialog.on("shown.bs.modal",function(){n.$loginDialog.find("#userName").focus()});var o=function(){if(n.$loginDialog.find("#userName").val()){n.setCookie("mgVideoChatSimple",n.$loginDialog.find("#userName").val(),30,j.location.hostname);n.$loginDialog.modal("hide");j.location.reload()}};n.$loginDialog.find("#userName").keypress(function(p){if(p.keyCode===13){o();return false}});n.$loginDialog.find("button.login").click(o);n.$videoPanel.find("#videoFullScreen").click(function(){var p=n.$videoPanel.get(0),q=p.requestFullScreen||p.webkitRequestFullScreen||p.mozRequestFullScreen;q.call(p)});n.$videoPanel.find("#videoExitFullScreen").click(function(){var p=k.cancelFullScreen||k.webkitCancelFullScreen||k.mozCancelFullScreen;p.call(k)});n.$videoPanel.find("#callHangup").click(function(){c.drop(n.videoId)});var m=function(t,s){if(!n.localStream){return false}var q=(s=="audio")?n.localStream.getAudioTracks():n.localStream.getVideoTracks();if(q.length===0){return false}var r;for(r=0;r<q.length;r++){q[r].enabled=n.isMuted[s]}n.isMuted[s]=!n.isMuted[s];var p=(n.isMuted[s])?"off":"on";t.attr("title",t.data("title-"+p));t.find("span").removeClass(t.data("icon-on")).removeClass(t.data("icon-off")).addClass(t.data("icon-"+p))};n.$videoPanel.find("#videoMute").click(function(){m(g(this),"video")});n.$videoPanel.find("#audioMute").click(function(){m(g(this),"audio")});n.$answerDialog.find("#answer").click(function(){c.accept(n.$answerDialog.data("caller_id"),n.getMediaOptions({audio:true,video:true}));n.$answerDialog.modal("hide")});n.$answerDialog.find("#answerAudio").click(function(){c.accept(n.$answerDialog.data("caller_id"),n.getMediaOptions({audio:true,video:false}));n.$answerDialog.modal("hide")});n.$answerDialog.find("#cancelCall").click(function(){c.drop(n.$answerDialog.data("caller_id"));n.$answerDialog.modal("hide")});n.$fileAcceptDialog.find("#fileAccept").click(function(){var p=n.$fileAcceptDialog.data("file_desc");var q=n.$fileAcceptDialog.data("connection_id");n.$fileAcceptDialog.modal("hide");p.firefox=c.firefox;n.fileAccept(p,q)});n.$fileAcceptDialog.find("#fileCancel").click(function(){var p=n.$fileAcceptDialog.data("file_desc");var q=n.$fileAcceptDialog.data("connection_id");n.fileCancel(p,q);n.$fileAcceptDialog.modal("hide")});g("#connectionsPanel").on("click","#rouletteNext",function(){n.rouletteNext()});g("[data-toggle=offcanvas]").click(function(){g(".row-offcanvas").toggleClass("active")})};l.prototype.updateLayout=function(){var m=this.$callPanel.is(":visible")||this.$chatPanel.is(":visible");var o=this.$elem.find("#mainContent");var n=this.$elem.find("#sideMenu");if(o.data("is_visible")===m){return false}if(m){o.removeClass().addClass("col-sm-8 col-xs-12 open");n.removeClass().addClass("col-sm-4 col-xs-6 sidebar-offcanvas");g("#offcanvasButton").show()}else{o.removeClass().addClass("col-sm-0");n.removeClass().addClass("col-sm-8 sidebar-offcanvas")}o.data("is_visible",m)};l.prototype.fileAccept=function(m,n){this.files[m.id].pending=false;this.renderFiles();c.fileAccept(n,m)};l.prototype.fileCancel=function(m,n){delete this.files[m.id];this.renderFiles();c.fileCancel(n,m)};l.prototype.setCookie=function(q,n,p,m){var o=(m&&m!="localhost")?("; domain="+m):"";k.cookie=q+"="+encodeURIComponent(n)+"; max-age="+(60*60*24*p)+"; path=/"+o};var i=null;l.prototype.message=function(q,o,n){if(i){j.clearTimeout(i)}var m=this;var p=m.$messagePanel.find(".alert");var r=m.$messagePanel.data("type");if(!q){m.$messagePanel.hide();return}p.removeClass("alert-"+r).addClass("alert-"+o);p.find("div.text").html(q);m.$messagePanel.data("type",o);m.$messagePanel.show();if(n){i=j.setTimeout(function(){m.$messagePanel.hide();i=null},n*1000)}};l.prototype.debug=function(m){if(this.config.debug){console.log(m)}};l.prototype.onConnected=function(){this.$loginPanel.show()};l.prototype.onDisconnected=function(){this.disableChat()};l.prototype.onLogged=function(){this.$loginPanel.hide()};l.prototype.onConnectionClose=function(m){this.$connectionsPanel.find("#connection_"+m).remove();this.disableChat(m);if(this.videoId==m){this.onVideoClose()}if(this.videoInvitedId==m){this.inviteStop()}delete c.connections[m];this.fire("connections",c.connections)};l.prototype.onVideoOpen=function(m){this.videoId=m;if(m){this.$callPanel.find(".panel-title").text(this._("Call with {username}",["{username}"],[c.connections[m]["data"]["userData"]["name"]]))}this.$callPanel.show();this.updateLayout();if(!this.roomOptions.group){this.renderConnections()}};l.prototype.onVideoClose=function(){var m=this;this.videoId=null;if(!this.roomOptions.group){m.$elem.find("#localVideo").attr("src","")}m.$elem.find("#remoteVideo").attr("src","");m.$callPanel.hide();m.inviteStop();this.renderConnections();this.remoteVideoGroupSelect()};l.prototype.inviteStart=function(m){this.videoAnswerDialog(m);this.videoInvitedId=m;this.callRing(false)};l.prototype.inviteStop=function(){this.$answerDialog.modal("hide");this.videoInvitedId=null;this.callRing(true)};l.prototype.videoAnswerDialog=function(o){var n=this;var m=c.connections[o].data.userData;n.$answerDialog.data("caller_id",o);n.$answerDialog.find(".username").text(m.name);if(m.image){n.$answerDialog.find(".desc").html('<img src="'+m.image+'" alt="'+m.name+'"/>')}n.$answerDialog.modal("show")};l.prototype.callRing=function(m){var n=this.$elem.find("#ringSound").get(0);if(m){n.pause()}else{n.play()}};l.prototype.notifySound=function(){this.$elem.find("#notifySound").get(0).play()};l.prototype.rouletteNext=function(){if(this.videoId){c.drop(this.videoId,false,true)}c.rouletteNext()};l.prototype.hasMedia=function(p,n){try{var m=(n=="audio")?p.getAudioTracks():p.getVideoTracks();return m.length>0}catch(o){return false}};l.prototype.localVideoOpen=function(n,m){if(n){this.$elem.find("#localVideo").attr("src",j.URL.createObjectURL(n));this.$elem.find("#localVideo").show();this.isMuted={audio:false,video:false};if(!this.hasMedia(n,"video")){this.$elem.find("#videoMute")}if(!this.hasMedia(n,"audio")){this.$elem.find("#audioMute")}}else{this.$elem.find("#localVideo").hide()}this.onVideoOpen(m)};l.prototype.remoteVideoOpen=function(n,m){if(n){this.$elem.find("#remoteVideo").attr("src",j.URL.createObjectURL(n));this.$elem.find("#remoteVideo").show()}else{this.$elem.find("#remoteVideo").hide()}if(m){this.onVideoOpen(m)}};l.prototype.remoteVideoGroupSelect=function(){if(!this.roomOptions.group||this.videoId){return}for(var n in c.connections){if(c.connections[n].rstream){var m=this.$connectionsPanel.find("#connection_"+n+".connectionItem");m.click()}}};l.prototype.getMediaOptions=function(m){m.video=m.video&&!this.roomOptions.disableVideo;m.audio=m.audio&&!this.roomOptions.disableAudio;return m};l.prototype.onRoomOptions=function(){var m=this;if(this.roomOptions.group||this.roomOptions.roulette){if(this.roomOptions.group){this.debug("This chat is group/conference chat");this.$videoPanel.find("#callHangup").remove()}else{this.config.tplConnections=this.config.tplRoulette;this.debug("This chat is roulette chat")}c.debug("creating local media stream");var o=function(s){c.mediaReady();if(m.roomOptions.group){m.connectAllMediaReady();m.setChat(0)}if(m.roomOptions.roulette){m.rouletteNext()}};c.createStream(null,this.getMediaOptions({audio:true,video:true}),function q(s){c.debug("local stream added");o(true)},function r(s){m.localStream=null;c.debug("local stream rejected");o(true)})}if(this.roomOptions.disableVideo){this.$answerDialog.find("#answer").hide();var n=this.$elem.find("#localVideoBg"),p=this.$elem.find("#remoteVideoBg");n.addClass("localAudio").show();p.addClass("remoteAudio").show();this.$elem.find("#localVideo").hide();this.$elem.find("#remoteVideo").hide()}if(this.roomOptions.disableAudio){this.$answerDialog.find("#answerAudio").hide()}};l.prototype.connectAllMediaReady=function(){var m=this;if(!this.roomOptions.group&&!this.roomOptions.roulette){return false}for(var n in c.connections){if(!c.connections[n].rstream&&c.connections[n].media_ready){if(!c.connections[n].stream){c.connections[n].stream=m.localStream}if(c.refuseIdleState(n)){return false}c.sdpOffer(n)}}};l.prototype.initRtc=function(){var m=this;c.on("connected",function(){c.login();m.onConnected()});c.on("connectionId",function(p){m.connectionId=p.connectionId;m.userData=p.data.data.userData;m.roomOptions=p.room;m.usersCount=p.users_count;m.onRoomOptions();m.renderYouInfo()});c.on("logged",function(){m.onLogged()});c.on("message",function(p){m.message(p.text,p.type)});c.on("chat_message",function(q){var p=m.roomOptions.group?0:q.connectionId;m.renderChatMessage(p,q.connectionId,q.message);if(m.chatId!=q.connectionId){if(!c.connections[q.connectionId]["data"].unread){c.connections[q.connectionId]["data"].unread=0}c.connections[q.connectionId]["data"].unread++;m.renderConnection(q.connectionId);m.notifySound()}});var n=0;c.on("call_busy",function(p){if(m.roomOptions.roulette&&n<5){m.debug("Callee is busy, try again "+n);n++;m.rouletteNext();return}m.message(m._("Callee is busy at the moment, please try later :("),"danger",3)});c.on("call_drop",function(p){c.stop(p.connectionId,false,m.roomOptions.roulette);if(m.roomOptions.roulette){c.connections={};m.renderConnections()}});c.on("media_ready",function(q){for(var p in q.data.connectionIds){c.connections[q.data.connectionIds[p]]["media_ready"]=true;if(m.localStream&&!c.connections[q.data.connectionIds[p]]["stream"]){c.connections[q.data.connectionIds[p]]["stream"]=m.localStream}}m.debug(c.connections)});c.on("connections",function(p){m.renderConnections()});var o={};c.on("roulette_next",function(p){if(!p||!p.connections){m.message(m._("No partner found at the moment. Please try later."),"warning",3);return false}m.usersCount=p.users_count;c.connections={};o=p});c.on("roulette_accept",function(p){c.connections=o.connections;o={};for(var q in c.connections){m.localVideoOpen(m.localStream,q)}m.connectAllMediaReady();m.renderConnections();m.notifySound()});c.on("roulette_invitation",function(p){m.usersCount=p.users_count;if(m.videoId){for(var q in p.connections){}m.debug("Busy for invitation from "+q);c.busy(q);c.drop(q);return false}c.connections=p.connections;for(var q in c.connections){c.connections[q].stream=m.localStream}c.rouletteAccept(q);m.localVideoOpen(m.localStream,q);m.renderConnections();m.notifySound()});c.on("connection_add",function(p){m.usersCount=p.users_count;m.renderConnection(p.connectionId)});c.on("connection_remove",function(p){m.usersCount=p.users_count;m.onConnectionClose(p.connectionId)});c.on("rstream_added",function(q,p){c.connections[p].rstream=q;if(!m.roomOptions.group){m.remoteVideoOpen(q);m.onVideoOpen(p)}else{m.remoteVideoGroupSelect()}});c.on("stream_added",function(q,p){m.localStream=q;m.localVideoOpen(q,p)});c.on("media_request_start",function(){m.$elem.find("#requestDialog").modal("show")});c.on("media_request_end",function(){m.$elem.find("#requestDialog").modal("hide")});c.on("status",function(q,p){switch(p){case"call_inviting":m.callRing(false);break;case"call_invited":if(m.videoId){c.busy(q);c.drop(q)}else{m.inviteStart(q)}break;case"call_accepting":case"call_accepted":m.$videoPanel.data("call_id",q);m.inviteStop();break;case"idle":m.callRing(true);if(m.videoId==q){m.onVideoClose()}if(m.videoInvitedId==q){m.inviteStop()}break;default:break}m.renderConnection(q)});c.on("socket_error",function(p){m.message(m._("Error connecting to media server: {error_name} {error_message}",["{error_name}","{error_message}"],[p.name,p.message]),"danger");m.onDisconnected()});c.on("socket_closed",function(p){m.message(m._("Websocket closed, please try reloading page later."),"danger");m.onDisconnected()});c.on("stream_error",function(p){m.message(m._("Error getting local media stream: {error_message}",["{error_message}"],[m.getErrorText(p)]),"danger")});c.on("pc_error",function(p){m.message(m._("Error creating peer connection: {error_name} {error_message}",["{error_name}","{error_message}"],[p.name,p.message]),"danger")});c.on("file_offer",function(r){var q=r.connectionId;var p=c.connections[q].data.userData;m.files[r.fileDesc.id]={desc:r.fileDesc,connectionId:q,pending:true};if(r.fileDesc.firefox!=c.firefox){m.message(m._("You and your peer are not using the same browser. File transfer between different browser most likely will not work."),"warning")}m.renderFiles();m.$fileAcceptDialog.data("file_desc",r.fileDesc);m.$fileAcceptDialog.data("connection_id",q);m.$fileAcceptDialog.find(".username").text(p.name);if(p.image){m.$fileAcceptDialog.find(".desc").html('<img src="'+p.image+'" alt="'+p.name+'"/>')}m.$fileAcceptDialog.find(".fileName").text(r.fileDesc.name);m.$fileAcceptDialog.find(".fileSize").text(m.getReadableFileSizeString(r.fileDesc.size));m.$fileAcceptDialog.modal("show");m.notifySound()});c.on("file_accept",function(p){if(p.fileDesc.firefox!=c.firefox){m.message(m._("You and your peer are not using the same browser. File transfer between different browser most likely will not work."),"warning")}c.fileSdpOffer(p.connectionId,p.fileDesc,{channelOnOpen:function(){m.debug("channelOnOpen connId: "+p.connectionId);m.debug(p);var s=c.connections[p.connectionId].sendChannel;var q=p.fileDesc.id;var r=m.files[q].file;a.send(r,s,{onFileProgress:function(t){m.debug("onFileProgress "+q+" connId: "+p.connectionId);m.debug(t);if(m.files[t.fileId]){m.files[t.fileId].progress=t;m.renderFileProgress(t.fileId)}},onFileSent:function(t){m.debug("onFileSent "+q+" connId: "+p.connectionId);m.debug(t);delete m.files[t.fileId];m.renderFiles()},calcTimeout:function(t){if(!m.files[t.fileId]){return -1}return(c.firefox)?5:500}})}})});c.on("file_receive_progress",function(p){if(!m.files[p.fileId]){return}m.files[p.fileId].packetsConfirmed=p.packets});c.on("file_sdp_offer",function(r){var q=r.connectionId;var p=r.fileDesc.id;c.connections[r.connectionId].fileOfferSdp=r.sdp;c.fileSdpAnswer(r.connectionId,r.fileDesc,{channelOnMessage:function(t){var s=JSON.parse(t.data);m.debug("channelOnMessage connId: "+s.connectionId+", order: "+s.order);a.receive(s,{onFileProgress:function(u){m.debug("onFileProgress "+p+" connId: "+s.connectionId);m.debug(u);if(m.files[u.fileId]){m.files[u.fileId].progress=u;m.renderFileProgress(u.fileId)}},autoSaveToDisk:true,onFileReceived:function(u,v){m.debug("onFileReceived file: "+u+", file id: "+p+" connId: "+s.connectionId);m.debug(v);delete m.files[v.fileId];m.renderFiles()}})}})});c.on("file_sdp_answer",function(q){var p=c.connections[q.connectionId].dpc;p.setRemoteDescription(new RTCSessionDescription(q.sdp))});c.on("file_cancel",function(p){delete m.files[p.fileDesc.id];m.renderFiles()})};l.prototype.getErrorText=function(n){var m=[];if(n.code){m.push(n.code)}if(n.name){m.push(n.name)}if(n.message){m.push(n.message)}if(m.length==0){m.push(n)}if(m[0]=="PermissionDeniedError"||m[0]=="PERMISSION_DENIED"){if(c.firefox){m.push(this._("Please enable requested media devices"))}else{m.push(this._("Please enable requested media devices by clicking on the right hand icon in the address bar."))}}return m.join(".\n")};l.prototype.getReadableFileSizeString=function(o){var n=-1;var m=[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"];do{o=o/1024;n++}while(o>1024);return Math.max(o,0.1).toFixed(1)+m[n]};l.prototype.renderConnections=function(){var m=this;m.debug("connections");m.debug(c.connections);this.loadTplByName("tplConnections",function(n){var o=m.tmpl(n,{rows:c.connections,roomOptions:m.roomOptions,usersCount:m.usersCount});m.$connectionsPanel.html(o);for(var p in c.connections){m.renderConnection(p)}if(!c.connections.length){m.$connectionsPanel.find("#lonely").show()}m.fire("connections",c.connections)})};l.prototype.renderConnection=function(n){var m=this;this.getConnectionElement(n,function(p){var o=m.$connectionsPanel.find("#connection_"+n);if(o.length){if(o.hasClass("active")){p.addClass("active")}o.replaceWith(p)}else{m.$connectionsPanel.find("#connections").append(p)}m.$connectionsPanel.find("#lonely").hide();m.fire("connections",c.connections)})};l.prototype.getConnectionElement=function(n,o){var m=this;if(!c.connections[n]){return false}this.loadTplByName("tplConnection",function(s){var q=c.connections[n],p=q.status?q.status:"idle";var t={id:n,status:p,userData:q.data["userData"],videoId:m.videoId,chatId:m.chatId,unread:(q.data.unread)?q.data.unread:0,connection:q,roomOptions:m.roomOptions};function u(v){m.$connectionsPanel.find(".connectionItem").removeClass("active");v.addClass("active")}var r=g(m.tmpl(s,t));if(m.roomOptions.group&&q.rstream){r.find("video").attr("src",j.URL.createObjectURL(q.rstream))}if(m.roomOptions.group){r.click(function(){u(g(this));var v=g(this).data("connection_id");if(c.connections[v].rstream){m.remoteVideoOpen(c.connections[v].rstream,v)}})}else{r.click(function(){u(g(this));m.setChat(g(this).data("connection_id"))})}r.find(".call.cmdBtn").click(function(){c.invite(g(this).data("id"),m.getMediaOptions({audio:true,video:true}))});r.find(".callAudio.cmdBtn").click(function(){c.invite(g(this).data("id"),m.getMediaOptions({audio:true,video:false}))});r.find(".answer.cmdBtn").click(function(){m.debug("Clicked to answer the connectionId: "+g(this).data("id"));c.accept(g(this).data("id"),m.getMediaOptions({audio:true,video:true}))});r.find(".drop.cmdBtn").click(function(){m.debug("Clicked to drop the connectionId: "+g(this).data("id"));c.drop(g(this).data("id"),false,m.roomOptions.roulette)});r.find(".fileSend.cmdBtn").click(function(){var v=g(this).data("id");m.debug("Clicked to send file to the connectionId: "+v);g("#fileDialog").off("change");g("#fileDialog").val("");g("#fileDialog").on("change",function(w){var z=w.target.files;for(var x=0,A;A=z[x];x++){A.connectionId=v;var y=a.getDesc(A);if(m.config.fileMaxSize&&y.size>m.config.fileMaxSize){m.message(m._("This file size of over maximum defined of {max_size}",["{max_size}"],[m.getReadableFileSizeString(m.config.fileMaxSize)]),"danger");continue}c.fileOffer(v,y);m.files[A.id]={file:A,desc:y,connectionId:v};m.renderFiles()}});g("#fileDialog").trigger("click")});if(m.chatId==n){r.addClass("active")}o(r)})};l.prototype.renderFiles=function(){var m=this;m.debug("files");m.debug(m.files);this.loadTplByName("tplFile",function(p){var n="";for(var o in m.files){var q=m.tmpl(p,{file:m.files[o],fileId:o,fileSize:m.getReadableFileSizeString(m.files[o].desc.size),roomOptions:m.roomOptions});n+=q}m.$filesPanel.find("#files").html(n);m.$filesPanel.find("a.fileAccept").click(function(){var r=g(this).data("file_id");var s=m.files[r].desc;var t=m.files[r].connectionId;m.fileAccept(s,t);return false});m.$filesPanel.find("a.fileCancel").click(function(){var r=g(this).data("file_id");var s=m.files[r].desc;var t=m.files[r].connectionId;m.fileCancel(s,t);return false});if(n==""){m.$filesPanel.hide()}else{m.$filesPanel.show()}})};l.prototype.renderYouInfo=function(){var m=this;m.debug(m.userData);this.loadTplByName("tplYou",function(n){m.$youInfoPanel.find("#youInfo").html(m.tmpl(n,{userData:m.userData}));if(!m.userData){m.$youInfoPanel.hide()}else{m.$youInfoPanel.show()}})};l.prototype.renderFileProgress=function(n){var p=this.files[n];if(!p){return false}var o=0;if(p.progress){o=(p.progress.transfered/p.progress.length)*100}var m=this.$filesPanel.find("#file_"+n);m.find(".progress-bar").css("width",o+"%");m.find(".progressText").text(o+"%")};l.prototype.getChatDiv=function(p){var n=this;var m=this.$chatPanel.find("#chat_"+p);if(!m.length){var o=this.loadTplByName("tplChatInput");m=g(n.tmpl(o,{chatId:p}));m.appendTo(n.$chatPanel.find("#chats"));m.find("textarea").keypress(function(r){var q=g(this);if(r.keyCode===13&&r.shiftKey){q.val(q.val()+"\n");return false}if(r.keyCode===13){c.chatMessage(p,q.val());n.renderChatMessage(p,n.connectionId,q.val());q.val("");return false}})}return m};l.prototype.disableChat=function(m){if(!m){this.$chatPanel.find(".form-control").attr("disabled","disabled")}else{this.$chatPanel.find("#chat_"+m+" .form-control").attr("disabled","disabled")}};l.prototype.setChat=function(m){this.chatId=m;this.$chatPanel.find(".chat").hide();this.getChatDiv(m).show();if(m>0){this.$chatPanel.find(".panel-title").text(this._("Chat with {username}",["{username}"],[c.connections[m]["data"]["userData"]["name"]]))}else{this.$chatPanel.find(".panel-title").text(this._("Group chat"))}this.$chatPanel.show();this.updateLayout();if(m&&c.connections[m]["data"].unread){c.connections[m]["data"].unread=0;this.renderConnection(m)}};l.prototype.parseChatMessageText=function(q){function p(t,s){var r=(s||typeof s==="undefined")?"<br />":"<br>";return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+r+"$2")}function n(s){var r=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return s.replace(r,"<a target=\"_blank\" href='$1'>$1</a>")}function o(v){var s,u,t,r;u=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;s=v.replace(u,'<a href="$1" target="_blank">$1</a>');t=/(^|[^\/])(www\.[\S]+(\b|$))/gim;s=s.replace(t,'$1<a href="http://$2" target="_blank">$2</a>');r=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;s=s.replace(r,'<a href="mailto:$1">$1</a>');return s}function m(t,y,x,s){var v=0,u=0,w=false;if(typeof y==="undefined"||y===null){y=2}t=t.toString();if(s!==false){t=t.replace(/&/g,"&amp;")}t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");var r={ENT_NOQUOTES:0,ENT_HTML_QUOTE_SINGLE:1,ENT_HTML_QUOTE_DOUBLE:2,ENT_COMPAT:2,ENT_QUOTES:3,ENT_IGNORE:4};if(y===0){w=true}if(typeof y!=="number"){y=[].concat(y);for(u=0;u<y.length;u++){if(r[y[u]]===0){w=true}else{if(r[y[u]]){v=v|r[y[u]]}}}y=v}if(y&r.ENT_HTML_QUOTE_SINGLE){t=t.replace(/'/g,"&#039;")}if(!w){t=t.replace(/"/g,"&quot;")}return t}return p(o(m(q)),false)};l.prototype.renderChatMessage=function(p,o,q){var n=this;var m=this.getChatDiv(p);this.loadTplByName("tplChat",function(r){var u={message:n.parseChatMessageText(q),me:false};if(o===n.connectionId){u.me=true;u.userData=n.userData}else{u.userData=c.connections[o]["data"]["userData"]}var t=n.tmpl(r,u);var s=m.find(".messages");s.append(t).scrollTop(s.get(0).scrollHeight)})};var b={};l.prototype.tmpl=function(p,o){try{var m=!/\W/.test(p)?b[p]=b[p]||tmpl(k.getElementById(p).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+p.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return o?m(o):m}catch(n){throw new Error("Error parsing template ["+p.substr(0,100)+"...]");this.debug(n)}};var h={};l.prototype.loadTplByName=function(m,n){return this.loadTpl(this.config.dir+this.config[m]+"?v="+this.version,n)};l.prototype.loadTpl=function(m,n){if(h[m]==null){g.get(m,function(o){h[m]=o;if(n){n(o)}},"html")}else{if(n){n(h[m])}}return h[m]};l.prototype.on=function(m,n){this.events[m]=this.events[m]||[];this.events[m].push(n)};l.prototype.fire=function(n,p){this.debug("mgVideoChat fired ["+n+"]");var r=this.events[n];var o=Array.prototype.slice.call(arguments,1);if(!r){return}for(var q=0,m=r.length;q<m;q++){r[q].apply(null,o)}};l.prototype._=function(n,o,m){return g.fn.mgVideoChat._(n,o,m)};g.fn.mgVideoChat=function(n,p,o){if(n==="on"){var m=g(this).data("mgVideoChat-instance");if(m){return m.on(p,o)}}else{this.each(function(){return new l(this,n)})}};g.fn.mgVideoChat._=function(p,r,o){var m=p;if(g.fn.mgVideoChat.translate&&g.fn.mgVideoChat.translate[p]){m=g.fn.mgVideoChat.translate[p]}if(!r||!r.length){return m}var q;for(var n=0;n<r.length;n++){q=new RegExp(r[n],"g");m=m.replace(q,o[n])}return m};var c={firefox:false};c.init=function(m){c.config=m;if(navigator.mozGetUserMedia){c.firefox=true}};c._socket=null;c._events={};c.on=function(m,n){c._events[m]=c._events[m]||[];c._events[m].push(n)};c.fire=function(n,p){c.debug("fired ["+n+"]");var r=c._events[n];var o=Array.prototype.slice.call(arguments,1);if(!r){return}for(var q=0,m=r.length;q<m;q++){r[q].apply(null,o)}};c.connections={};c.id=null;c.compatible=true;c.debug=function(m){if(d.debug){console.log(m)}};c.checkCompatibility=function(m){c.compatible=true;if(!j.WebSocket){m.websocket=true;c.compatible=false}if(!j.RTCPeerConnection&&!j.PeerConnection){m.peerconnection=true;c.compatible=false}if(!navigator.getUserMedia){m.usermedia=true;c.compatible=false}return c.compatible};c.connect=function(m){c._socket=new WebSocket(m);c._socket.onopen=function(){c.fire("connected")};c._socket.onmessage=function(o){var n=JSON.parse(o.data);c.debug("RECEIVED MESSAGE "+n.type);c.debug(n);c.fire(n.type,n.data)};c._socket.onerror=function(n){c.debug("onerror");c.debug(n);c.fire("socket_error",n)};c._socket.onclose=function(n){c.fire("socket_closed",{})}};c.on("connections",function(m){c.connections=m});c.on("connectionId",function(m){c.id=m.connectionId;c.fire("logged",m.data)});c.on("connection_add",function(m){c.connections[m.connectionId]=m.data});c.on("connection_remove",function(m){delete c.connections[m.connectionId]});c.on("call_invite",function(m){c.setStatus(m.connectionId,"call_invited")});c.on("call_accept",function(m){if(c.refuseIdleState(m.connectionId)){return false}c.setStatus(m.connectionId,"call_accepted");c.sdpOffer(m.connectionId)});c.on("sdp_offer",function(m){if(c.refuseIdleState(m.connectionId)){return false}c.connections[m.connectionId].offerSdp=m.sdp;c.setStatus(m.connectionId,"sdp_offered");c.sdpAnswer(m.connectionId)});c.on("sdp_answer",function(n){if(c.refuseIdleState(n.connectionId)){return false}var m=c.connections[n.connectionId].pc;c.remoteSDReceive(m,n.sdp);c.setStatus(n.connectionId,"sdp_answered")});c.on("ice_candidate",function(n){if(c.refuseIdleState(n.connectionId)){return false}var m=c.connections[n.connectionId].pc;c.debug("Adding ice candidate:");c.debug({sdpMLineIndex:n.label,candidate:n.candidate});m.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:n.label,candidate:n.candidate}),function(){c.debug("Remote candidate added successfully.")},function(o){c.debug("Failed to add remote candidate: "+o.toString())})});c.setStatus=function(n,m){c.debug("status ["+m+"] for connectionId: "+n);c.connections[n].status=m;c.fire("status",n,m)};c.refuseIdleState=function(n){var m=n&&c.connections[n].status=="idle";if(m){c.debug("refusing idle state of connection id: "+n)}return m};c.send=function(m){c.debug("SENDING MSG "+m.type);c.debug(m);c._socket.send(JSON.stringify(m))};c.mediaReady=function(){c.send({type:"media_ready",data:{}})};c.rouletteNext=function(){c.send({type:"roulette_next",data:{}})};c.rouletteAccept=function(m){c.send({type:"roulette_accept",data:{connectionId:m}})};c.chatMessage=function(m,n){c.send({type:"chat_message",data:{connectionId:m,message:n}})};c.login=function(m){c.send({type:"login",data:m})};c.invite=function(n,m){c.debug("creating local media stream");c.setStatus(n,"call_inviting");c.createStream(n,m,function(o){c.debug("inviting call for id: "+n);c.send({type:"call_invite",data:{connectionId:n}})})};c.accept=function(n,m){c.debug("creating local media stream");c.createStream(n,m,function(o){c.debug("accepting call from id: "+n);c.send({type:"call_accept",data:{connectionId:n}});c.setStatus(n,"call_accepting")})};c.drop=function(n,m,o){c.debug("droping call");c.send({type:"call_drop",data:{connectionId:n}});if(c.connections[n]){c.stop(n,m,o)}};c.busy=function(m){c.debug("sending busy signal");c.send({type:"call_busy",data:{connectionId:m}})};c.stop=function(n,m,o){if(!c.connections[n]){return false}if(!m&&c.connections[n].pc){c.connections[n].pc.close();c.connections[n].pc=null}if(!o&&c.connections[n].stream){c.connections[n].stream.stop()}c.setStatus(n,"idle")};c.mergeConstraints=function(o,n){var m=o;for(var p in n.mandatory){m.mandatory[p]=n.mandatory[p]}m.optional.concat(n.optional);return m};c.onCreateSessionDescriptionError=function(m){c.debug("Failed to create session description: "+m.toString())};c.extractSdp=function(n,o){var m=n.match(o);return(m&&m.length==2)?m[1]:null};c.setDefaultCodec=function(n,q){var p=n.split(" ");var r=new Array();var m=0;for(var o=0;o<p.length;o++){if(m===3){r[m++]=q}if(p[o]!==q){r[m++]=p[o]}}return r.join(" ")};c.removeCN=function(n,r){var p=n[r].split(" ");for(var m=n.length-1;m>=0;m--){var q=c.extractSdp(n[m],/a=rtpmap:(\d+) CN\/\d+/i);if(q){var o=p.indexOf(q);if(o!==-1){p.splice(o,1)}n.splice(m,1)}}n[r]=p.join(" ");return n};c.preferAudioCodec=function(n){if(!c.config.audio_receive_codec){return n}var s=c.config.audio_receive_codec;var p=s.split("/");if(p.length!=2){return n}var m=p[0];var q=p[1];var u=n.split("\r\n");for(var o=0;o<u.length;o++){if(u[o].search("m=audio")!==-1){var v=o;break}}if(v===null){return n}for(var o=0;o<u.length;o++){if(u[o].search(m+"/"+q)!==-1){var r=new RegExp(":(\\d+) "+m+"\\/"+q,"i");var t=c.extractSdp(u[o],r);if(t){u[v]=c.setDefaultCodec(u[v],t)}break}}u=c.removeCN(u,v);n=u.join("\r\n");return n};c.remoteSDReceive=function(m,n){m.setRemoteDescription(new RTCSessionDescription(n),function(){c.debug("Set remote session description success.");var o=m.getRemoteStreams();if(o.length>0&&o[0].getVideoTracks().length>0){c.debug("Waiting for remote video tracks")}},function(o){c.debug("Set remote session description error "+o.toString())})};c.localSDSend=function(m,p,o,n){o.sdp=c.preferAudioCodec(o.sdp);c.debug("Setting local sessionDescription and sending msg "+n);c.debug(o);m.setLocalDescription(o,function(){c.debug("Set local session description success.")},function(q){c.debug("Set local session description error "+q.toString())});c.send({type:n,data:{connectionId:p,sdp:o}})};c.sdpOffer=function(n){var m=c.createPeerConnection(n);var o=c.mergeConstraints(c.config.offerConstraints,c.config.sdpConstraints);c.debug("Sending offer to peer, with constraints: \n  '"+JSON.stringify(o)+"'.");m.createOffer(function(p){c.localSDSend(m,n,p,"sdp_offer")},c.onCreateSessionDescriptionError,o);c.setStatus(n,"sdp_offering")};c.sdpAnswer=function(n){c.debug("Answering call connectionId: "+n);var m=c.createPeerConnection(n);c.remoteSDReceive(m,c.connections[n].offerSdp);c.debug("Sending answer to peer, with constraints: \n  '"+JSON.stringify(c.config.sdpConstraints)+"'.");m.createAnswer(function(o){c.localSDSend(m,n,o,"sdp_answer")},c.onCreateSessionDescriptionError,c.config.sdpConstraints);c.setStatus(n,"sdp_answering")};c.createStream=function(n,m,q,r){q=q||function(s){};r=r||function(s){c.debug("Could not connect stream with error:");c.debug(s)};try{c.fire("media_request_start");var p=g.extend({},c.config.mediaConstraints,m);navigator.getUserMedia(p,function(s){c.fire("media_request_end");if(c.refuseIdleState(n)){s.stop();return false}if(n){c.connections[n].stream=s}c.fire("stream_added",s,n);q(s)},function(s){c.fire("media_request_end");r(s);c.fire("stream_error",s)})}catch(o){c.fire("media_request_end");c.fire("stream_error",o)}};c.createPeerConnection=function(n){c.debug("createPeerConnection for id: "+n);try{c.connections[n].pc=new j.RTCPeerConnection(c.config.pcConfig,c.config.pcConstraints);c.connections[n].pc.onicecandidate=function(p){c.debug("pc.onicecandidate, event:");c.debug(p);if(p.candidate){c.send({type:"ice_candidate",data:{candidate:p.candidate.candidate,connectionId:n,label:p.candidate.sdpMLineIndex}})}else{c.debug("End of ICE candidates")}};c.debug("Created RTCPeerConnnection with:\n  config: '"+JSON.stringify(c.config.pcConfig)+"';\n  constraints: '"+JSON.stringify(c.config.pcConstraints)+"'.")}catch(o){c.debug("Failed to create RTCPeerConnection, exception: "+o.message);c.fire("pc_error",o);alert("Cannot create PeerConnection object; Is the 'PeerConnection' flag enabled in about:flags?");return null}var m=c.connections[n].pc;m.onconnecting=function(){c.debug("Session connecting.")};m.onopen=function(){c.debug("Session opened.");c.fire("pc_opened",n)};m.onaddstream=function(p){c.debug("Remote stream added.");c.fire("rstream_added",p.stream,n);c.setStatus(n,"call")};m.onremovestream=function(){c.debug("Remote stream removed.")};if(c.connections[n].stream){m.addStream(c.connections[n].stream)}m.onsignalingstatechange=function(){c.debug("PC Signaling state changed to: "+m.signalingState)};m.oniceconnectionstatechange=function(){c.debug("ICE connection state changed to: "+m.iceConnectionState)};return m};c.fileOffer=function(n,m){c.debug("offering file to connection "+n);c.debug(m);c.send({type:"file_offer",data:{connectionId:n,fileDesc:m}})};c.fileAccept=function(n,m){c.debug("accepting file from id: "+n);c.debug(m);c.send({type:"file_accept",data:{connectionId:n,fileDesc:m}})};c.fileCancel=function(n,m){c.debug("canceling file sending to "+n);c.debug(m);c.send({type:"file_cancel",data:{connectionId:n,fileDesc:m}})};c.fileSdpOffer=function(p,o,n){var m=c.fileGetPeerConnection(p,n,true);var q=c.mergeConstraints(c.config.offerConstraints,c.config.sdpConstraints);m.createOffer(function(r){m.setLocalDescription(r);c.send({type:"file_sdp_offer",data:{connectionId:p,sdp:r,fileDesc:o}})},function(r){c.debug("Failed to create session description offer: "+r.toString())},q)};c.fileSdpAnswer=function(p,o,n){c.debug("Answering call connectionId: "+p);var m=c.fileGetPeerConnection(p,n);var q=c.mergeConstraints(c.config.offerConstraints,c.config.sdpConstraints);m.setRemoteDescription(new RTCSessionDescription(c.connections[p].fileOfferSdp));m.createAnswer(function(r){m.setLocalDescription(r);c.send({type:"file_sdp_answer",data:{connectionId:p,sdp:r,fileDesc:o}})},function(r){c.debug("Failed to create session description answer: "+r.toString())},q)};c.fileGetPeerConnection=function(r,o,q){try{c.debug("fileGetPeerConnection for id: "+r+" does not exist, creating it");if(!c.firefox){var t={optional:[{RtpDataChannels:true}]}}else{var t={optional:[]}}c.connections[r].dpc=new j.RTCPeerConnection(c.config.pcConfig,t);c.connections[r].dpc.onicecandidate=function(u){if(u.candidate){c.send({type:"file_ice_candidate",data:{candidate:u.candidate.candidate,connectionId:r,label:u.candidate.sdpMLineIndex}})}}}catch(s){c.debug("Failed to create RTCPeerConnection, exception: "+s.message);c.fire("dpc_error",s);alert("Cannot create PeerConnection object; Is the 'PeerConnection' flag enabled in about:flags?");return null}var n=c.connections[r].dpc;n.onopen=function(){c.debug("File peerconnection opened for conn id: "+r)};var p=function(u){if(o.channelOnMessage){u.onmessage=o.channelOnMessage}if(o.channelOnOpen){u.onopen=o.channelOnOpen}if(o.channelOnClose){u.onclose=o.channelOnClose}if(o.channelOnError){u.onerror=o.channelOnError}};var m=function(){if(!q){return false}c.debug("creating send channel");var u=(c.firefox)?{}:{reliable:false};c.connections[r].sendChannel=c.connections[r].dpc.createDataChannel("sendDataChannel"+r,u);if(c.firefox){c.connections[r].sendChannel.binaryType="blob"}p(c.connections[r].sendChannel)};n.ondatachannel=function(u){if(!q){c.debug("creating receive channel");c.connections[r].receiveChannel=u.channel;if(c.firefox){c.connections[r].receiveChannel.binaryType="blob"}p(c.connections[r].receiveChannel)}};m();return n};c.fileReceiveProgress=function(n,m,o){c.send({type:"file_receive_progress",data:{connectionId:n,fileId:m,packets:o}})};c.on("file_ice_candidate",function(n){var m=c.connections[n.connectionId].dpc;m.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:n.label,candidate:n.candidate}))});var a={getDesc:function(m){if(!m.id){m.id=(Math.random()*new Date().getTime()).toString(36).toUpperCase().replace(/\./g,"-")}return{name:m.name,size:m.size,type:m.type,id:m.id,connectionId:m.connectionId,firefox:c.firefox}},send:function(n,t,u){var s=800,m=0,r=0,o=0;var q=new j.FileReader();var p=function(w,z){var y={type:"file",name:n.name,packets:0,id:n.id,connectionId:n.connectionId,order:o};o++;if(w){z=w.target.result;m=r=y.packets=parseInt(Math.ceil(z.length/s))}else{y.packets=m}if(z.length>s){y.message=z.slice(0,s)}else{y.message=z;y.last=true}t.send(JSON.stringify(y));var v={remaining:--r,length:m,sent:m-r,transfered:m-r,fileId:y.id};if(u.onFileProgress){u.onFileProgress(v,n)}if(y.last&&u.onFileSent){u.onFileSent(v)}z=z.slice(y.message.length);var x=500;if(u.calcTimeout){x=u.calcTimeout(v);if(x<0){return}}if(z.length){setTimeout(function(){p(null,z)},x)}};q.onload=p;q.readAsDataURL(n)},recContent:{},recPackets:{},recNumberOfPackets:{},receive:function(q,o){var s=q.id;if(q.packets&&!a.recNumberOfPackets[s]){a.recNumberOfPackets[s]=a.recPackets[s]=parseInt(q.packets)}if(o.onFileProgress){o.onFileProgress({remaining:--a.recPackets[s],length:a.recNumberOfPackets[s],received:a.recNumberOfPackets[s]-a.recPackets[s],transfered:a.recNumberOfPackets[s]-a.recPackets[s],fileId:s},s)}if(!a.recContent[s]){a.recContent[s]={}}a.recContent[s][q.order]=q.message;if(q.last){var r="";for(var p=0;p<a.recNumberOfPackets[s];p++){r+=a.recContent[s][p]}var n=a.dataUrlToBlob(r);var m=(j.URL||j.webkitURL).createObjectURL(n);if(o.autoSaveToDisk){a.saveToDisk(r,q.name)}if(o.onFileReceived){o.onFileReceived(q.name,{blob:n,dataURL:r,url:m,fileId:s})}delete a.recContent[s]}},saveToDisk:function(m,p){var o=k.createElement("a");o.href=m;o.target="_blank";o.download=p||m;var n=new MouseEvent("click",{view:j,bubbles:true,cancelable:true});o.dispatchEvent(n);(j.URL||j.webkitURL).revokeObjectURL(o.href)},dataUrlToBlob:function(p){var r=atob(p.substr(p.indexOf(",")+1));var q=[];for(var m=0;m<r.length;m++){q.push(r.charCodeAt(m))}var n;try{n=p.substr(p.indexOf(":")+1).split(";")[0]}catch(o){n="text/plain"}return new Blob([new Uint8Array(q)],{type:n})}}})(jQuery,window,document);